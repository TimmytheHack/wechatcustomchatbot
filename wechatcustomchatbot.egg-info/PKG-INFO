Metadata-Version: 2.4
Name: wechatcustomchatbot
Version: 0.1.0
Summary: Single-user, self-hosted WeChat LLM bot brain kit
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: fastapi>=0.110
Requires-Dist: uvicorn>=0.27
Requires-Dist: pydantic>=2.6
Requires-Dist: PyYAML>=6.0
Requires-Dist: APScheduler>=3.10
Requires-Dist: httpx>=0.27
Requires-Dist: python-dotenv>=1.0

# WeChat Custom Chat Bot (Brain Kit)

This repo provides a single-user, self-hosted "brain" for a personal WeChat account. It does not include any WeChat personal-account hook or SDK. You bring your own connector adapter and run the bot locally.

## What this is

- FastAPI service that accepts normalized inbound events via HTTP.
- LLM-driven replies with optional GIFs from a local library.
- Per-chat isolated state: messages, rolling summary, counters, and scheduled plans.
- Event-driven proactive planning (schedule future messages only when inbound messages arrive).
- Dumb executor for due messages using APScheduler.

## What this is NOT

- Not a WeChat Official Account bot.
- Not a personal WeChat hook/SDK implementation.

## Quickstart

1) Create a virtual environment and install dependencies

```bash
python -m venv .venv
.venv\Scripts\activate
pip install -e .
```

2) Create config files

```bash
copy .env.example .env
copy config.yaml.example config.yaml
```

3) Edit `config.yaml`

- Set `security.shared_secret` to a random value.
- Adjust `timezone`, `tone`, and `gif_folder` as needed.

4) Run the bot

```bash
python -m bot.main
```

5) Send a test event

```bash
python scripts\send_test_event.py --secret CHANGE_ME --text "hello"
```

You should see output from the stub connector and the reply stored in SQLite.

Or via curl:

```bash
curl -X POST http://127.0.0.1:8000/wechat/event ^
  -H "Content-Type: application/json" ^
  -H "X-BOT-SECRET: CHANGE_ME" ^
  -d "{\"chat_id\":\"demo\",\"chat_type\":\"direct\",\"sender_id\":\"user-1\",\"timestamp\":1737164000,\"text\":\"hello\",\"is_mention\":false}"
```

## Connector adapters

The bot expects a connector adapter that implements:

- `send_text(chat_id: str, text: str) -> None`
- `send_gif(chat_id: str, gif_path: str) -> None`

A stub connector is provided at `bot/connector_stub.py`. To implement your own:

1) Copy `connectors/template_adapter.py` to `connectors/my_adapter.py`.
2) Implement the send functions.
3) Update `config.yaml`:

```yaml
runtime:
  connector: "connectors.my_adapter:MyConnector"
```

## Running across two laptops

- Run the bot brain on one machine and your WeChat client/connector on another.
- The connector should POST inbound events to `http://<brain-ip>:8000/wechat/event`.
- Add header `X-BOT-SECRET: <shared_secret>`.
- You can use LAN, VPN, Tailscale, or WireGuard. There is no hard dependency.

## Inbound event format

```json
{
  "chat_id": "string",
  "chat_type": "direct|group",
  "sender_id": "string",
  "timestamp": 1737164000,
  "text": "string",
  "is_mention": false
}
```

## LLM configuration

Configure an OpenAI-compatible API in `.env`:

- `LLM_BASE_URL`
- `LLM_API_KEY`
- `LLM_MODEL`

If any are missing, the bot runs in dummy mode and echoes the user text without proactive scheduling.

## GIF library

Put GIFs in `assets/gifs`. Tags are inferred from filenames using underscores or hyphens.
Example: `happy_wave_01.gif` yields tags `happy` and `wave`.

## Data storage

SQLite database (default `data/bot.db`) stores:

- messages
- conversations (summary, counters)
- plans (scheduled outbound messages)

## Notes

- Proactive messaging is off by default.
- Quiet hours and cooldown are enforced in the configured timezone.
- Group chats only reply when mentioned unless configured otherwise.

## API endpoints

- `POST /wechat/event` (auth header required)
- `GET /health`
